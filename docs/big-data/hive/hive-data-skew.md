---
title: Hive 数据倾斜
sidebar_position: 3
tags: [大数据, Hive]
---

## 什么是数据倾斜

在大数据处理中，数据倾斜是指数据集中某些分区或某些属性的值过多，导致大量数据集中在少数的几个节点上，导致查询效率低下。

## 导致数据倾斜的原因

在 map 和 reduce 两个阶段中，最容易出现数据倾斜的就是 reduce 阶段，因为 map 到 reduce 会经过 shuffle 阶段，在 shuffle 中默认会按照 key 进行 hash，如果相同的 key 过多，那么 hash 的结果就是大量相同的 key 进入到同一个 reduce 中，导致数据倾斜。

在 map 阶段也有可能会发生数据倾斜，例如在一个任务中，数据文件在进入 map 阶段之前会进行切分，默认是 128M 一个数据块，但是如果当对文件使用 GZIP 压缩等不支持文件分割操作的压缩方式时，MR 任务读取压缩后的文件时，是对它切分不了的，该压缩文件只会被一个任务所读取，如果有一个超大的不可切分的压缩文件被一个 map 读取时，就会发生 map 阶段的数据倾斜。

所以数据倾斜的原因有两种：

1. reduce 阶段：一个任务处理大量的数据
2. map 阶段：一个任务读取不可分割的大文件

### 空值引发的数据倾斜

实际的业务中有很多的空值，如果表进行 join 操作，会有 shuffle 操作，所有的空值的 key 相同 hash 结果也相同会被放到一个 reduce 中。

**解决方案：**

不让空值参与 join 操作，或者使用 join 条件中包含非空值。

```sql
SELECT * FROM table1 t1
JOIN table2 t2 ON t1.id = t2.id AND t2.name IS NOT NULL;
```

### 不同的数据类型引发的数据倾斜

join 的时候，A 表字段为 int 类型，B 表字段有 int 也有 string 类型，默认的 hash 操作会按照 int 类型进行分配，而 string 的数据会被分配为同一个 id，所以所有的 string 类型的数据都会被分配到同一个 reduce 中，导致数据倾斜。

**解决方案：**

将 int 类型转换为 string 类型

```sql
SELECT * FROM table1 t1
JOIN table2 t2 ON t1.id = t2.id AND CAST(t2.name AS STRING) = 'xxx';
```

### 不可拆分的文件引起的数据倾斜

当对文件使用 GZIP 压缩等不支持文件分割操作的压缩方式，在日后有作业涉及读取压缩后的文件时，该压缩文件只会被一个任务所读取。如果文件较大，则会引起数据倾斜。

**解决方案：**

我们在对文件进行压缩时，为避免因不可拆分大文件而引发数据读取的倾斜，在数据压缩的时候可以采用 bzip2 和 Zip 等支持文件分割的压缩算法。

### 

## 数据倾斜的现象

## 解决数据倾斜的方法
